var app=function(){"use strict";function e(){}function t(e){return e()}function n(){return Object.create(null)}function o(e){e.forEach(t)}function i(e){return"function"==typeof e}function a(e,t){return e!=e?t==t:e!==t||e&&"object"==typeof e||"function"==typeof e}function r(e,t,n){e.insertBefore(t,n||null)}function s(e){e.parentNode&&e.parentNode.removeChild(e)}function c(e,t,n){null==n?e.removeAttribute(t):e.getAttribute(t)!==n&&e.setAttribute(t,n)}function l(e){const t={};for(const n of e)t[n.name]=n.value;return t}let d;function u(e){d=e}function h(){if(!d)throw new Error("Function called outside component initialization");return d}const m=[],g=[];let p=[];const f=[],B=Promise.resolve();let $=!1;function _(e){p.push(e)}const b=new Set;let x=0;function y(){if(0!==x)return;const e=d;do{try{for(;x<m.length;){const e=m[x];x++,u(e),w(e.$$)}}catch(e){throw m.length=0,x=0,e}for(u(null),m.length=0,x=0;g.length;)g.pop()();for(let e=0;e<p.length;e+=1){const t=p[e];b.has(t)||(b.add(t),t())}p.length=0}while(m.length);for(;f.length;)f.pop()();$=!1,b.clear(),u(e)}function w(e){if(null!==e.fragment){e.update(),o(e.before_update);const t=e.dirty;e.dirty=[-1],e.fragment&&e.fragment.p(e.ctx,t),e.after_update.forEach(_)}}const v=new Set;function A(e,t){const n=e.$$;null!==n.fragment&&(!function(e){const t=[],n=[];p.forEach((o=>-1===e.indexOf(o)?t.push(o):n.push(o))),n.forEach((e=>e())),p=t}(n.after_update),o(n.on_destroy),n.fragment&&n.fragment.d(t),n.on_destroy=n.fragment=null,n.ctx=[])}function L(e,t){-1===e.$$.dirty[0]&&(m.push(e),$||($=!0,B.then(y)),e.$$.dirty.fill(0)),e.$$.dirty[t/31|0]|=1<<t%31}function O(a,r,c,l,h,m,g,p=[-1]){const f=d;u(a);const B=a.$$={fragment:null,ctx:[],props:m,update:e,not_equal:h,bound:n(),on_mount:[],on_destroy:[],on_disconnect:[],before_update:[],after_update:[],context:new Map(r.context||(f?f.$$.context:[])),callbacks:n(),dirty:p,skip_bound:!1,root:r.target||f.$$.root};g&&g(B.root);let $=!1;if(B.ctx=c?c(a,r.props||{},((e,t,...n)=>{const o=n.length?n[0]:t;return B.ctx&&h(B.ctx[e],B.ctx[e]=o)&&(!B.skip_bound&&B.bound[e]&&B.bound[e](o),$&&L(a,e)),t})):[],B.update(),$=!0,o(B.before_update),B.fragment=!!l&&l(B.ctx),r.target){if(r.hydrate){const e=function(e){return Array.from(e.childNodes)}(r.target);B.fragment&&B.fragment.l(e),e.forEach(s)}else B.fragment&&B.fragment.c();r.intro&&((b=a.$$.fragment)&&b.i&&(v.delete(b),b.i(x))),function(e,n,a,r){const{fragment:s,after_update:c}=e.$$;s&&s.m(n,a),r||_((()=>{const n=e.$$.on_mount.map(t).filter(i);e.$$.on_destroy?e.$$.on_destroy.push(...n):o(n),e.$$.on_mount=[]})),c.forEach(_)}(a,r.target,r.anchor,r.customElement),y()}var b,x;u(f)}let N;"function"==typeof HTMLElement&&(N=class extends HTMLElement{constructor(){super(),this.attachShadow({mode:"open"})}connectedCallback(){const{on_mount:e}=this.$$;this.$$.on_disconnect=e.map(t).filter(i);for(const e in this.$$.slotted)this.appendChild(this.$$.slotted[e])}attributeChangedCallback(e,t,n){this[e]=n}disconnectedCallback(){o(this.$$.on_disconnect)}$destroy(){A(this,1),this.$destroy=e}$on(t,n){if(!i(n))return e;const o=this.$$.callbacks[t]||(this.$$.callbacks[t]=[]);return o.push(n),()=>{const e=o.indexOf(n);-1!==e&&o.splice(e,1)}}$set(e){var t;this.$$set&&(t=e,0!==Object.keys(t).length)&&(this.$$.skip_bound=!0,this.$$set(e),this.$$.skip_bound=!1)}});let z=document.currentScript&&document.currentScript.src||new URL("fds-3d-scene.js",document.baseURI).href;class k{static async getInfo(e,t){let n="",o="",i=!1;t&&(t=t.replace("@fds-components/",""),n=k.get_href()+e+"-"+t+".json",o=`@fds-components/${t}/dist/${e}-${t}.json`);let a=await fetch(n).then((e=>(e.ok||(i=!0),e.json()))).then((t=>"api"!==e?t:t?t.components?t.components[0]:t:void 0));return i&&(a=await fetch(o).then((e=>(e.ok||(i=!0),e.json()))).then((t=>"api"!==e?t:t?t.components?t.components[0]:t:void 0))),a}static get_href(){return new URL("./",z).href}static get_local(){return new URL("./",z).pathname}}var M="@fds-components/fds-3d-scene",C="1.0.14";function Y(t){let n;return{c(){n=function(e){return document.createElement(e)}("canvas"),this.c=e,c(n,"id","renderCanvas"),c(n,"width",t[1]),c(n,"height",t[2]),c(n,"class","canvas")},m(e,o){r(e,n,o),t[21](n)},p(e,t){2&t[0]&&c(n,"width",e[1]),4&t[0]&&c(n,"height",e[2])},i:e,o:e,d(e){e&&s(n),t[21](null)}}}function S(e){let t=e;for(;t;){if(t.gizmoHere)return t;t=t.parent}return e}function I(e){if("__root__"===e.parent.name)return!1;for(;"__root__"!==e.parent.name;)if("Mesh"===(e=e.parent).getClassName())return!0;return!1}function E(e){if("__root__"===e.parent.name)return e;for(;"__root__"!==e.parent.name;)e=e.parent;return e}function D(e,t,n){let o=h(),{width:i=1e3}=t,{height:a=1e3}=t,{external_scene_storage:r=null}=t,{move_gizmo_thickness:s=1}=t,{bounding_gizmo_thickness:c=.03}=t,{camera_behaviour:l=""}=t;const d=C;let{base64:u}=t,{binary:m}=t;var p;let f;p=()=>(V(Q),()=>{r&&n(5,r.data=_(),r)}),h().$$.on_mount.push(p);let{scene:B}=t;let $=function(){return new Promise((e=>{setTimeout((()=>{e("")}),100)}))};function _(){let e=O;N("");let t={},n=B.activeCamera;t.position=JSON.parse(JSON.stringify(n.position)),t.rotation=JSON.parse(JSON.stringify(n.rotation)),F.camera=t;for(let e of F.meshes){let t=B.getMeshByName(e.name);if(!t)return alert("mesh not found"+e.name),null;let n={scaling:t.scaling.clone(),rotationQ:t.rotationQuaternion.clone(),position:t.position.clone()};e.positionData=n}return N(e),F}let b,x,y,w,v,A,L,{mode:O=""}=t;function N(e){v&&(v.opacity=1,v.setParent(null)),w&&w.dispose(),v&&(v.isPickable=!0),w&&(w.isPickable=!1),y&&(y.attachedMesh=null),x&&(x.attachedMesh=null),b&&(b.attachedMesh=null),v&&("move"===e&&(y&&(y.attachedMesh=null),x.attachedMesh=v,v.opacity=.5),"scale_rotate"===e&&(w=BABYLON.BoundingBoxGizmo.MakeNotPickableAndWrapInBoundingBox(v),A.utilityLayerScene.autoClearDepthAndStencil=!1,y=new BABYLON.BoundingBoxGizmo(BABYLON.Color3.FromHexString("#0984e3"),A),y.scaleBoxSize=parseFloat(c),y.rotationSphereSize=parseFloat(c),y.attachedMesh=w))}function z(e){o.dispatchEvent(new CustomEvent("change",{detail:e}))}let Y,D,{background_type:G="transparent"}=t,P=null;function R(e="grey"){B&&("transparent"===e&&(P&&(P.dispose(),P=null),n(4,B.clearColor=new BABYLON.Color4(0,0,0,0),B)),"grey"===e&&(P||(P=B.createDefaultEnvironment({enableGroundShadow:!0}),P.setMainColor(BABYLON.Color3.Gray()),P.ground.position.y+=.01),n(4,B.clearColor=Y,B)),"black"===e&&(P&&(P.dispose(),P=null),n(4,B.clearColor=new BABYLON.Color4(0,0,0,255),B)))}function V(e){f=new BABYLON.Engine(e,!0,{preserveDrawingBuffer:!0,stencil:!0}),f.enableOfflineSupport=!1,f.resize(),BABYLON.Animation.AllowMatricesInterpolation=!0,n(4,B=new BABYLON.Scene(f)),Y=B.clearColor;let t=new BABYLON.ArcRotateCamera("camera1",Math.PI/2,Math.PI/2,3,new BABYLON.Vector3(0,1,0),B);t.attachControl(e,!0),t.lowerRadiusLimit=1.2,t.upperRadiusLimit=8,t.wheelDeltaPercentage=.01,t.onViewMatrixChangedObservable.add((()=>{z({type:"camera",position:t.position,rotation:t.rotation})}));let o=new BABYLON.HemisphericLight("light1",new BABYLON.Vector3(0,1,0),B);o.intensity=.6,o.specular=BABYLON.Color3.Black();let i=new BABYLON.DirectionalLight("dir01",new BABYLON.Vector3(0,-.5,-1),B);i.position=new BABYLON.Vector3(0,5,5);let a=new BABYLON.ShadowGenerator(1024,i);a.useBlurExponentialShadowMap=!0,a.blurKernel=32;var r=new BABYLON.GridMaterial("groundMaterial",B);r.majorUnitFrequency=1,r.minorUnitVisibility=.1,r.gridRatio=1,r.backFaceCulling=!1,r.mainColor=new BABYLON.Color3(0,0,0),r.lineColor=new BABYLON.Color3(0,0,0),r.opacity=.2,BABYLON.Mesh.CreateGround("ground1",20,20,2,B).material=r,R(G),function(){let e;A=new BABYLON.UtilityLayerRenderer(B),L=new BABYLON.UtilityLayerRenderer(B),x=new BABYLON.PositionGizmo(L,parseInt(s)),b=new BABYLON.RotationGizmo(A),y=new BABYLON.ScaleGizmo(A),x.xGizmo.dragBehavior.onDragEndObservable.add((()=>{z({type:"position",axis:"x"})})),x.yGizmo.dragBehavior.onDragEndObservable.add((()=>{z({type:"position",axis:"y"})})),x.zGizmo.dragBehavior.onDragEndObservable.add((()=>{z({type:"position",axis:"z"})})),b.xGizmo.dragBehavior.onDragEndObservable.add((()=>{z({type:"rotation",axis:"x"})})),b.yGizmo.dragBehavior.onDragEndObservable.add((()=>{z({type:"rotation",axis:"y"})})),b.zGizmo.dragBehavior.onDragEndObservable.add((()=>{z({type:"rotation",axis:"z"})})),y.xGizmo.dragBehavior.onDragEndObservable.add((()=>{z({type:"scale",axis:"x"})})),y.yGizmo.dragBehavior.onDragEndObservable.add((()=>{z({type:"scale",axis:"y"})})),y.zGizmo.dragBehavior.onDragEndObservable.add((()=>{z({type:"scale",axis:"z"})})),new BABYLON.AxisScaleGizmo(new BABYLON.Vector3(0,1,0),BABYLON.Color3.FromHexString("#00b894"),A).attachedNode=null,b.updateGizmoRotationToMatchAttachedMesh=!1,b.updateGizmoPositionToMatchAttachedMesh=!0,x.updateGizmoPositionToMatchAttachedMesh=!0,n(4,B.onPointerDown=function(){const t=B.pick(this.pointerX,this.pointerY);if(t.hit&&(e=t.pickedMesh.name),t.hit&&"ground1"!==e&&"__root__"!==e&&!e.includes("Background")){if("box"===t.pickedMesh.name)return;if("scale_rotate"===O){v&&(v.opacity=1),v&&(v.isPickable=!0),v&&v.setParent(null),w&&w.dispose(),y&&(y.attachedMesh=null);let e=S(t.pickedMesh);w=BABYLON.BoundingBoxGizmo.MakeNotPickableAndWrapInBoundingBox(e),A.utilityLayerScene.autoClearDepthAndStencil=!1,y=new BABYLON.BoundingBoxGizmo(BABYLON.Color3.FromHexString("#0984e3"),A),y.scaleBoxSize=parseFloat(c),y.rotationSphereSize=parseFloat(c),y.attachedMesh=w,v=e}if("move"===O){A.utilityLayerScene.autoClearDepthAndStencil=!0,v&&(v.opacity=1);let e=S(t.pickedMesh);x.attachedMesh=e,v=e,v.opacity=.5}}},B)}(),function(e){e.runRenderLoop((function(){B&&B.activeCamera&&B.render()}))}(f),f.hideLoadingUI(),D=B.enableDepthRenderer()}let F={meshes:[],camera:{}};async function U(e,t=null){let n={base64:e};await BABYLON.SceneLoader.AppendAsync("",e,B);try{B.stopAllAnimations();let e,o=B.meshes,i=[];for(let e of o)e&&!e.loaded&&(e.loaded=!0,"ground1"===e.name||"__root__"===e.name||e.name.includes("Background")||(i.push(e),i.loaded=!0,i.isPickable=!0));let a=!0;try{e=BABYLON.Mesh.MergeMeshes(i,!0,!0)}catch(t){let n={};for(let e of i){if(!I(e)){let t=E(e);if(n[t.name]){let o=n[t.name];o.min=BABYLON.Vector3.Minimize(o.min,e.getBoundingInfo().boundingBox.minimumWorld),o.max=BABYLON.Vector3.Maximize(o.max,e.getBoundingInfo().boundingBox.maximumWorld)}else{let o={tn:t,min:e.getBoundingInfo().boundingBox.minimumWorld,max:e.getBoundingInfo().boundingBox.maximumWorld};n[t.name]=o}}e.parent}a=!1;for(const t in n){let o=n[t];e=new BABYLON.Mesh("parent",B),o.tn.setParent(e),e.gizmoHere=!0,e.setBoundingInfo(new BABYLON.BoundingInfo(o.min,o.max))}}if(a){e.loaded=!0;let t=e.getBoundingInfo().boundingBox.minimum,n=e.getBoundingInfo().boundingBox.maximum.subtract(t),o=Math.max(n.x,n.y,n.z);e.position=new BABYLON.Vector3(0,0,0),e.rotationQuaternion=new BABYLON.Quaternion(0,0,0,1);let i=1/o;e.scaling=new BABYLON.Vector3(i,i,i)}t&&(e.rotationQuaternion=new BABYLON.Quaternion(t.rotationQ._x,t.rotationQ._y,t.rotationQ._z,t.rotationQ._w),e.position=new BABYLON.Vector3(t.position._x,t.position._y,t.position._z),e.scaling=new BABYLON.Vector3(t.scaling._x,t.scaling._y,t.scaling._z)),n.name=e.name,F.meshes.push(n)}catch(e){}}let{canvas:Q}=t;return e.$$set=e=>{"width"in e&&n(1,i=e.width),"height"in e&&n(2,a=e.height),"external_scene_storage"in e&&n(5,r=e.external_scene_storage),"move_gizmo_thickness"in e&&n(6,s=e.move_gizmo_thickness),"bounding_gizmo_thickness"in e&&n(7,c=e.bounding_gizmo_thickness),"camera_behaviour"in e&&n(8,l=e.camera_behaviour),"base64"in e&&n(3,u=e.base64),"binary"in e&&n(11,m=e.binary),"scene"in e&&n(4,B=e.scene),"mode"in e&&n(16,O=e.mode),"background_type"in e&&n(19,G=e.background_type),"canvas"in e&&n(0,Q=e.canvas)},e.$$.update=()=>{e.$$.dirty[0],524288&e.$$.dirty[0]&&G&&R(G),65536&e.$$.dirty[0]&&N(O),273&e.$$.dirty[0]&&B&&(l||B.activeCamera.attachControl(Q,!0),"lock"===l&&B.activeCamera.detachControl()),2048&e.$$.dirty[0]&&m&&n(3,u="data:base64,"+function(e){let t="";for(var n,o="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",i=new Uint8Array(e),a=i.byteLength,r=a%3,s=a-r,c=0;c<s;c+=3)t+=o[(16515072&(n=i[c]<<16|i[c+1]<<8|i[c+2]))>>18]+o[(258048&n)>>12]+o[(4032&n)>>6]+o[63&n];return 1==r?t+=o[(252&(n=i[s]))>>2]+o[(3&n)<<4]+"==":2==r&&(t+=o[(64512&(n=i[s]<<8|i[s+1]))>>10]+o[(1008&n)>>4]+o[(15&n)<<2]+"="),t}(m)),8&e.$$.dirty[0]&&u&&U(u)},[Q,i,a,u,B,r,s,c,l,async function(e){return"version"===e?new Promise((e=>{e(C)})):await k.getInfo(e,M)},d,m,async function(){let e=B.meshes;if(!e.length)return;N("");let t=e[0].getBoundingInfo().boundingBox.minimumWorld,o=e[0].getBoundingInfo().boundingBox.maximumWorld;for(let n of e)if("ground1"!==n.name&&"__root__"!==n.name&&!n.name.includes("Background")){const e=n.getBoundingInfo().boundingBox.minimumWorld,i=n.getBoundingInfo().boundingBox.maximumWorld;t=BABYLON.Vector3.Minimize(t,e),o=BABYLON.Vector3.Maximize(o,i)}let i=Math.max(o.x,o.y),a=B.activeCamera.minZ,r=B.activeCamera.maxZ;n(4,B.activeCamera.minZ=1.2,B),n(4,B.activeCamera.maxZ=i,B),await $();let s=D.getDepthMap(),c=Q.width,l=Q.height,d=new Promise((e=>{s.readPixels().then((t=>{for(let e=0;e<t.length;e+=4)t[e+1]=t[e+2]=t[e];BABYLON.Tools.DumpData(s.getSize().width,s.getSize().height,t,(t=>{let n=window.document.createElement("canvas");n.width=c,n.height=l;const o=new Image;o.src=t,o.onload=()=>{let t=n.getContext("2d");t.scale(1,-1),t.filter="invert(1)",t.drawImage(o,0,-l,c,l);let i=n.toDataURL();e(i)}}))}))})),u=await d;return n(4,B.activeCamera.minZ=a,B),n(4,B.activeCamera.maxZ=r,B),u},_,async function(e){F.meshes=[],B.dispose(),V(Q);let t=B.activeCamera;t.position=e.camera.position,t.rotation=e.camera.rotation;for(let t of e.meshes)await U(t.base64,t.positionData);N("")},async function(){let e=O;N(""),await $();let t=Q.toDataURL();return N(e),t},O,N,function(){if(!v)return;let e=v.name;v.dispose(),v=null,N("");let t=0;for(let n of F.meshes){if(n.name===e)return void F.meshes.splice(t,-1);t++}},G,R,function(e){g[e?"unshift":"push"]((()=>{Q=e,n(0,Q)}))}]}class G extends N{constructor(e){super();const t=document.createElement("style");t.textContent=".canvas{width:100%;height:100%}*{box-sizing:border-box}",this.shadowRoot.appendChild(t),O(this,{target:this.shadowRoot,props:l(this.attributes),customElement:!0},D,Y,a,{width:1,height:2,external_scene_storage:5,move_gizmo_thickness:6,bounding_gizmo_thickness:7,camera_behaviour:8,getInfo:9,version:10,base64:3,binary:11,scene:4,renderForAI:12,getScene:13,setScene:14,renderNormal:15,mode:16,setMode:17,deleteMesh:18,background_type:19,setBackground:20,canvas:0},null,[-1,-1]),e&&(e.target&&r(e.target,this,e.anchor),e.props&&(this.$set(e.props),y()))}static get observedAttributes(){return["width","height","external_scene_storage","move_gizmo_thickness","bounding_gizmo_thickness","camera_behaviour","getInfo","version","base64","binary","scene","renderForAI","getScene","setScene","renderNormal","mode","setMode","deleteMesh","background_type","setBackground","canvas"]}get width(){return this.$$.ctx[1]}set width(e){this.$$set({width:e}),y()}get height(){return this.$$.ctx[2]}set height(e){this.$$set({height:e}),y()}get external_scene_storage(){return this.$$.ctx[5]}set external_scene_storage(e){this.$$set({external_scene_storage:e}),y()}get move_gizmo_thickness(){return this.$$.ctx[6]}set move_gizmo_thickness(e){this.$$set({move_gizmo_thickness:e}),y()}get bounding_gizmo_thickness(){return this.$$.ctx[7]}set bounding_gizmo_thickness(e){this.$$set({bounding_gizmo_thickness:e}),y()}get camera_behaviour(){return this.$$.ctx[8]}set camera_behaviour(e){this.$$set({camera_behaviour:e}),y()}get getInfo(){return this.$$.ctx[9]}get version(){return this.$$.ctx[10]}get base64(){return this.$$.ctx[3]}set base64(e){this.$$set({base64:e}),y()}get binary(){return this.$$.ctx[11]}set binary(e){this.$$set({binary:e}),y()}get scene(){return this.$$.ctx[4]}set scene(e){this.$$set({scene:e}),y()}get renderForAI(){return this.$$.ctx[12]}get getScene(){return this.$$.ctx[13]}get setScene(){return this.$$.ctx[14]}get renderNormal(){return this.$$.ctx[15]}get mode(){return this.$$.ctx[16]}set mode(e){this.$$set({mode:e}),y()}get setMode(){return this.$$.ctx[17]}get deleteMesh(){return this.$$.ctx[18]}get background_type(){return this.$$.ctx[19]}set background_type(e){this.$$set({background_type:e}),y()}get setBackground(){return this.$$.ctx[20]}get canvas(){return this.$$.ctx[0]}set canvas(e){this.$$set({canvas:e}),y()}}return customElements.define("fds-3d-scene",G),G}();
