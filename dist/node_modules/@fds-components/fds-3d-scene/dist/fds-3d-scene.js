var app=function(){"use strict";function e(){}function t(e){return e()}function n(){return Object.create(null)}function o(e){e.forEach(t)}function a(e){return"function"==typeof e}function r(e,t){return e!=e?t==t:e!==t||e&&"object"==typeof e||"function"==typeof e}function i(e,t,n){e.insertBefore(t,n||null)}function s(e){e.parentNode&&e.parentNode.removeChild(e)}function c(e,t,n){null==n?e.removeAttribute(t):e.getAttribute(t)!==n&&e.setAttribute(t,n)}function l(e){const t={};for(const n of e)t[n.name]=n.value;return t}let d;function u(e){d=e}function h(){if(!d)throw new Error("Function called outside component initialization");return d}const m=[],g=[];let f=[];const p=[],B=Promise.resolve();let $=!1;function b(e){f.push(e)}const x=new Set;let y=0;function _(){if(0!==y)return;const e=d;do{try{for(;y<m.length;){const e=m[y];y++,u(e),w(e.$$)}}catch(e){throw m.length=0,y=0,e}for(u(null),m.length=0,y=0;g.length;)g.pop()();for(let e=0;e<f.length;e+=1){const t=f[e];x.has(t)||(x.add(t),t())}f.length=0}while(m.length);for(;p.length;)p.pop()();$=!1,x.clear(),u(e)}function w(e){if(null!==e.fragment){e.update(),o(e.before_update);const t=e.dirty;e.dirty=[-1],e.fragment&&e.fragment.p(e.ctx,t),e.after_update.forEach(b)}}const v=new Set;function A(e,t){const n=e.$$;null!==n.fragment&&(!function(e){const t=[],n=[];f.forEach((o=>-1===e.indexOf(o)?t.push(o):n.push(o))),n.forEach((e=>e())),f=t}(n.after_update),o(n.on_destroy),n.fragment&&n.fragment.d(t),n.on_destroy=n.fragment=null,n.ctx=[])}function L(e,t){-1===e.$$.dirty[0]&&(m.push(e),$||($=!0,B.then(_)),e.$$.dirty.fill(0)),e.$$.dirty[t/31|0]|=1<<t%31}function O(r,i,c,l,h,m,g,f=[-1]){const p=d;u(r);const B=r.$$={fragment:null,ctx:[],props:m,update:e,not_equal:h,bound:n(),on_mount:[],on_destroy:[],on_disconnect:[],before_update:[],after_update:[],context:new Map(i.context||(p?p.$$.context:[])),callbacks:n(),dirty:f,skip_bound:!1,root:i.target||p.$$.root};g&&g(B.root);let $=!1;if(B.ctx=c?c(r,i.props||{},((e,t,...n)=>{const o=n.length?n[0]:t;return B.ctx&&h(B.ctx[e],B.ctx[e]=o)&&(!B.skip_bound&&B.bound[e]&&B.bound[e](o),$&&L(r,e)),t})):[],B.update(),$=!0,o(B.before_update),B.fragment=!!l&&l(B.ctx),i.target){if(i.hydrate){const e=function(e){return Array.from(e.childNodes)}(i.target);B.fragment&&B.fragment.l(e),e.forEach(s)}else B.fragment&&B.fragment.c();i.intro&&((x=r.$$.fragment)&&x.i&&(v.delete(x),x.i(y))),function(e,n,r,i){const{fragment:s,after_update:c}=e.$$;s&&s.m(n,r),i||b((()=>{const n=e.$$.on_mount.map(t).filter(a);e.$$.on_destroy?e.$$.on_destroy.push(...n):o(n),e.$$.on_mount=[]})),c.forEach(b)}(r,i.target,i.anchor,i.customElement),_()}var x,y;u(p)}let N;"function"==typeof HTMLElement&&(N=class extends HTMLElement{constructor(){super(),this.attachShadow({mode:"open"})}connectedCallback(){const{on_mount:e}=this.$$;this.$$.on_disconnect=e.map(t).filter(a);for(const e in this.$$.slotted)this.appendChild(this.$$.slotted[e])}attributeChangedCallback(e,t,n){this[e]=n}disconnectedCallback(){o(this.$$.on_disconnect)}$destroy(){A(this,1),this.$destroy=e}$on(t,n){if(!a(n))return e;const o=this.$$.callbacks[t]||(this.$$.callbacks[t]=[]);return o.push(n),()=>{const e=o.indexOf(n);-1!==e&&o.splice(e,1)}}$set(e){var t;this.$$set&&(t=e,0!==Object.keys(t).length)&&(this.$$.skip_bound=!0,this.$$set(e),this.$$.skip_bound=!1)}});let M=document.currentScript&&document.currentScript.src||new URL("fds-3d-scene.js",document.baseURI).href;class C{static async getInfo(e,t){let n="",o="",a=!1;t&&(t=t.replace("@fds-components/",""),n=C.get_href()+e+"-"+t+".json",o=`@fds-components/${t}/dist/${e}-${t}.json`);let r=await fetch(n).then((e=>(e.ok||(a=!0),e.json()))).then((t=>"api"!==e?t:t?t.components?t.components[0]:t:void 0));return a&&(r=await fetch(o).then((e=>(e.ok||(a=!0),e.json()))).then((t=>"api"!==e?t:t?t.components?t.components[0]:t:void 0))),r}static get_href(){return new URL("./",M).href}static get_local(){return new URL("./",M).pathname}}var Y="@fds-components/fds-3d-scene",z="1.0.10";function k(t){let n;return{c(){n=function(e){return document.createElement(e)}("canvas"),this.c=e,c(n,"id","renderCanvas"),c(n,"width",t[1]),c(n,"height",t[2]),c(n,"class","canvas")},m(e,o){i(e,n,o),t[19](n)},p(e,t){2&t[0]&&c(n,"width",e[1]),4&t[0]&&c(n,"height",e[2])},i:e,o:e,d(e){e&&s(n),t[19](null)}}}function S(e){let t=e;for(;t;){if(t.gizmoHere)return t;t=t.parent}return e}function E(e){if("__root__"===e.parent.name)return!1;for(;"__root__"!==e.parent.name;)if("Mesh"===(e=e.parent).getClassName())return!0;return!1}function I(e){if("__root__"===e.parent.name)return e;for(;"__root__"!==e.parent.name;)e=e.parent;return e}function D(e,t,n){let o=h(),{width:a=1e3}=t,{height:r=1e3}=t,{external_scene_storage:i=null}=t,{camera_behaviour:s=""}=t;const c=z;let{base64:l}=t,{binary:d}=t;var u;let m;u=()=>()=>{i&&n(5,i.data=B(),i)},h().$$.on_mount.push(u);let{scene:f}=t;let p=function(){return new Promise((e=>{setTimeout((()=>{e("")}),100)}))};function B(){let e=A;L("");let t={},n=f.activeCamera;t.position=JSON.parse(JSON.stringify(n.position)),t.rotation=JSON.parse(JSON.stringify(n.rotation)),R.camera=t;for(let e of R.meshes){let t=f.getMeshByName(e.name);if(!t)return alert("mesh not found"+e.name),null;let n={scaling:t.scaling.clone(),rotationQ:t.rotationQuaternion.clone(),position:t.position.clone()};e.positionData=n}return L(e),R}let $,b,x,y,_,w,v,{mode:A=""}=t;function L(e){_&&(_.opacity=1,_.setParent(null)),y&&y.dispose(),_&&(_.isPickable=!0),y&&(y.isPickable=!1),x&&(x.attachedMesh=null),b&&(b.attachedMesh=null),$&&($.attachedMesh=null),_&&("move"===e&&(x&&(x.attachedMesh=null),b.attachedMesh=_,_.opacity=.5),"scale_rotate"===e&&(y=BABYLON.BoundingBoxGizmo.MakeNotPickableAndWrapInBoundingBox(_),w.utilityLayerScene.autoClearDepthAndStencil=!1,x=new BABYLON.BoundingBoxGizmo(BABYLON.Color3.FromHexString("#0984e3"),w),x.rotationSphereSize=.03,x.scaleBoxSize=.03,x.attachedMesh=y))}function O(e){o.dispatchEvent(new CustomEvent("change",e))}let N,M,{background_type:k="transparent"}=t,D=null;function G(e="grey"){f&&("transparent"===e&&(D&&(D.dispose(),D=null),n(4,f.clearColor=new BABYLON.Color4(0,0,0,0),f)),"grey"===e&&(D||(D=f.createDefaultEnvironment({enableGroundShadow:!0}),D.setMainColor(BABYLON.Color3.Gray()),D.ground.position.y+=.01),n(4,f.clearColor=N,f)),"black"===e&&(D&&(D.dispose(),D=null),n(4,f.clearColor=new BABYLON.Color4(0,0,0,255),f)))}function P(e){m=new BABYLON.Engine(e,!0,{preserveDrawingBuffer:!0,stencil:!0}),m.enableOfflineSupport=!1,m.resize(),BABYLON.Animation.AllowMatricesInterpolation=!0,n(4,f=new BABYLON.Scene(m)),N=f.clearColor;let t=new BABYLON.ArcRotateCamera("camera1",Math.PI/2,Math.PI/2,3,new BABYLON.Vector3(0,1,0),f);t.attachControl(e,!0),t.lowerRadiusLimit=1.2,t.upperRadiusLimit=8,t.wheelDeltaPercentage=.01,t.onViewMatrixChangedObservable.add((()=>{O({type:"camera",position:t.position,rotation:t.rotation})}));let o=new BABYLON.HemisphericLight("light1",new BABYLON.Vector3(0,1,0),f);o.intensity=.6,o.specular=BABYLON.Color3.Black();let a=new BABYLON.DirectionalLight("dir01",new BABYLON.Vector3(0,-.5,-1),f);a.position=new BABYLON.Vector3(0,5,5);let r=new BABYLON.ShadowGenerator(1024,a);r.useBlurExponentialShadowMap=!0,r.blurKernel=32;var i=new BABYLON.GridMaterial("groundMaterial",f);i.majorUnitFrequency=1,i.minorUnitVisibility=.1,i.gridRatio=1,i.backFaceCulling=!1,i.mainColor=new BABYLON.Color3(0,0,0),i.lineColor=new BABYLON.Color3(0,0,0),i.opacity=.2,BABYLON.Mesh.CreateGround("ground1",20,20,2,f).material=i,G(k),function(){let e;w=new BABYLON.UtilityLayerRenderer(f),v=new BABYLON.UtilityLayerRenderer(f),b=new BABYLON.PositionGizmo(v),$=new BABYLON.RotationGizmo(w),x=new BABYLON.ScaleGizmo(w),b.xGizmo.dragBehavior.onDragEndObservable.add((()=>{O({type:"position",axis:"x"})})),b.yGizmo.dragBehavior.onDragEndObservable.add((()=>{O({type:"position",axis:"y"})})),b.zGizmo.dragBehavior.onDragEndObservable.add((()=>{O({type:"position",axis:"z"})})),$.xGizmo.dragBehavior.onDragEndObservable.add((()=>{O({type:"rotation",axis:"x"})})),$.yGizmo.dragBehavior.onDragEndObservable.add((()=>{O({type:"rotation",axis:"y"})})),$.zGizmo.dragBehavior.onDragEndObservable.add((()=>{O({type:"rotation",axis:"z"})})),x.xGizmo.dragBehavior.onDragEndObservable.add((()=>{O({type:"scale",axis:"x"})})),x.yGizmo.dragBehavior.onDragEndObservable.add((()=>{O({type:"scale",axis:"y"})})),x.zGizmo.dragBehavior.onDragEndObservable.add((()=>{O({type:"scale",axis:"z"})})),new BABYLON.AxisScaleGizmo(new BABYLON.Vector3(0,1,0),BABYLON.Color3.FromHexString("#00b894"),w).attachedNode=null,$.updateGizmoRotationToMatchAttachedMesh=!1,$.updateGizmoPositionToMatchAttachedMesh=!0,b.updateGizmoPositionToMatchAttachedMesh=!0,n(4,f.onPointerDown=function(){const t=f.pick(this.pointerX,this.pointerY);if(t.hit&&(e=t.pickedMesh.name),t.hit&&"ground1"!==e&&"__root__"!==e&&!e.includes("Background")){if("box"===t.pickedMesh.name)return;if("scale_rotate"===A){_&&(_.opacity=1),_&&(_.isPickable=!0),_&&_.setParent(null),y&&y.dispose(),x&&(x.attachedMesh=null);let e=S(t.pickedMesh);y=BABYLON.BoundingBoxGizmo.MakeNotPickableAndWrapInBoundingBox(e),w.utilityLayerScene.autoClearDepthAndStencil=!1,x=new BABYLON.BoundingBoxGizmo(BABYLON.Color3.FromHexString("#0984e3"),w),x.rotationSphereSize=.03,x.scaleBoxSize=.03,x.attachedMesh=y,_=e}if("move"===A){w.utilityLayerScene.autoClearDepthAndStencil=!0,_&&(_.opacity=1);let e=S(t.pickedMesh);b.attachedMesh=e,_=e,_.opacity=.5}}},f)}(),function(e){e.runRenderLoop((function(){f&&f.activeCamera&&f.render()}))}(m),m.hideLoadingUI(),M=f.enableDepthRenderer()}let R={meshes:[],camera:{}};async function V(e,t=null){let n={base64:e};await BABYLON.SceneLoader.AppendAsync("",e,f);try{f.stopAllAnimations();let e,o=f.meshes,a=[];for(let e of o)e&&!e.loaded&&(e.loaded=!0,"ground1"===e.name||"__root__"===e.name||e.name.includes("Background")||(a.push(e),a.loaded=!0,a.isPickable=!0));let r=!0;try{e=BABYLON.Mesh.MergeMeshes(a,!0,!0)}catch(t){let n={};for(let e of a){if(!E(e)){let t=I(e);if(n[t.name]){let o=n[t.name];o.min=BABYLON.Vector3.Minimize(o.min,e.getBoundingInfo().boundingBox.minimumWorld),o.max=BABYLON.Vector3.Maximize(o.max,e.getBoundingInfo().boundingBox.maximumWorld)}else{let o={tn:t,min:e.getBoundingInfo().boundingBox.minimumWorld,max:e.getBoundingInfo().boundingBox.maximumWorld};n[t.name]=o}}e.parent}r=!1;for(const t in n){let o=n[t];e=new BABYLON.Mesh("parent",f),o.tn.setParent(e),e.gizmoHere=!0,e.setBoundingInfo(new BABYLON.BoundingInfo(o.min,o.max))}}if(r){e.loaded=!0;let t=e.getBoundingInfo().boundingBox.minimum,n=e.getBoundingInfo().boundingBox.maximum.subtract(t),o=Math.max(n.x,n.y,n.z);e.position=new BABYLON.Vector3(0,0,0),e.rotationQuaternion=new BABYLON.Quaternion(0,0,0,1);let a=1/o;e.scaling=new BABYLON.Vector3(a,a,a)}t&&(e.rotationQuaternion=new BABYLON.Quaternion(t.rotationQ._x,t.rotationQ._y,t.rotationQ._z,t.rotationQ._w),e.position=new BABYLON.Vector3(t.position._x,t.position._y,t.position._z),e.scaling=new BABYLON.Vector3(t.scaling._x,t.scaling._y,t.scaling._z)),n.name=e.name,R.meshes.push(n)}catch(e){}}let{canvas:U}=t;return e.$$set=e=>{"width"in e&&n(1,a=e.width),"height"in e&&n(2,r=e.height),"external_scene_storage"in e&&n(5,i=e.external_scene_storage),"camera_behaviour"in e&&n(6,s=e.camera_behaviour),"base64"in e&&n(3,l=e.base64),"binary"in e&&n(9,d=e.binary),"scene"in e&&n(4,f=e.scene),"mode"in e&&n(14,A=e.mode),"background_type"in e&&n(17,k=e.background_type),"canvas"in e&&n(0,U=e.canvas)},e.$$.update=()=>{1&e.$$.dirty[0]&&U&&P(U),131072&e.$$.dirty[0]&&k&&G(k),16384&e.$$.dirty[0]&&L(A),81&e.$$.dirty[0]&&f&&(s||f.activeCamera.attachControl(U,!0),"lock"===s&&f.activeCamera.detachControl()),512&e.$$.dirty[0]&&d&&n(3,l="data:base64,"+function(e){let t="";for(var n,o="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",a=new Uint8Array(e),r=a.byteLength,i=r%3,s=r-i,c=0;c<s;c+=3)t+=o[(16515072&(n=a[c]<<16|a[c+1]<<8|a[c+2]))>>18]+o[(258048&n)>>12]+o[(4032&n)>>6]+o[63&n];return 1==i?t+=o[(252&(n=a[s]))>>2]+o[(3&n)<<4]+"==":2==i&&(t+=o[(64512&(n=a[s]<<8|a[s+1]))>>10]+o[(1008&n)>>4]+o[(15&n)<<2]+"="),t}(d)),8&e.$$.dirty[0]&&l&&V(l)},[U,a,r,l,f,i,s,async function(e){return"version"===e?new Promise((e=>{e(z)})):await C.getInfo(e,Y)},c,d,async function(){let e=f.meshes;if(!e.length)return;L("");let t=e[0].getBoundingInfo().boundingBox.minimumWorld,o=e[0].getBoundingInfo().boundingBox.maximumWorld;for(let n of e)if("ground1"!==n.name&&"__root__"!==n.name&&!n.name.includes("Background")){const e=n.getBoundingInfo().boundingBox.minimumWorld,a=n.getBoundingInfo().boundingBox.maximumWorld;t=BABYLON.Vector3.Minimize(t,e),o=BABYLON.Vector3.Maximize(o,a)}let a=Math.max(o.x,o.y),r=f.activeCamera.minZ,i=f.activeCamera.maxZ;n(4,f.activeCamera.minZ=1.2,f),n(4,f.activeCamera.maxZ=a,f),await p();let s=M.getDepthMap(),c=U.width,l=U.height,d=new Promise((e=>{s.readPixels().then((t=>{for(let e=0;e<t.length;e+=4)t[e+1]=t[e+2]=t[e];BABYLON.Tools.DumpData(s.getSize().width,s.getSize().height,t,(t=>{let n=window.document.createElement("canvas");n.width=c,n.height=l;const o=new Image;o.src=t,o.onload=()=>{let t=n.getContext("2d");t.scale(1,-1),t.filter="invert(1)",t.drawImage(o,0,-l,c,l);let a=n.toDataURL();e(a)}}))}))})),u=await d;return n(4,f.activeCamera.minZ=r,f),n(4,f.activeCamera.maxZ=i,f),u},B,async function(e){R.meshes=[],f.dispose(),P(U);let t=f.activeCamera;t.position=e.camera.position,t.rotation=e.camera.rotation;for(let t of e.meshes)await V(t.base64,t.positionData);L("")},async function(){let e=A;L(""),await p();let t=U.toDataURL();return L(e),t},A,L,function(){if(!_)return;let e=_.name;_.dispose(),_=null,L("");let t=0;for(let n of R.meshes){if(n.name===e)return void R.meshes.splice(t,-1);t++}},k,G,function(e){g[e?"unshift":"push"]((()=>{U=e,n(0,U)}))}]}class G extends N{constructor(e){super();const t=document.createElement("style");t.textContent=".canvas{width:100%;height:100%}*{box-sizing:border-box}",this.shadowRoot.appendChild(t),O(this,{target:this.shadowRoot,props:l(this.attributes),customElement:!0},D,k,r,{width:1,height:2,external_scene_storage:5,camera_behaviour:6,getInfo:7,version:8,base64:3,binary:9,scene:4,renderForAI:10,getScene:11,setScene:12,renderNormal:13,mode:14,setMode:15,deleteMesh:16,background_type:17,setBackground:18,canvas:0},null,[-1,-1]),e&&(e.target&&i(e.target,this,e.anchor),e.props&&(this.$set(e.props),_()))}static get observedAttributes(){return["width","height","external_scene_storage","camera_behaviour","getInfo","version","base64","binary","scene","renderForAI","getScene","setScene","renderNormal","mode","setMode","deleteMesh","background_type","setBackground","canvas"]}get width(){return this.$$.ctx[1]}set width(e){this.$$set({width:e}),_()}get height(){return this.$$.ctx[2]}set height(e){this.$$set({height:e}),_()}get external_scene_storage(){return this.$$.ctx[5]}set external_scene_storage(e){this.$$set({external_scene_storage:e}),_()}get camera_behaviour(){return this.$$.ctx[6]}set camera_behaviour(e){this.$$set({camera_behaviour:e}),_()}get getInfo(){return this.$$.ctx[7]}get version(){return this.$$.ctx[8]}get base64(){return this.$$.ctx[3]}set base64(e){this.$$set({base64:e}),_()}get binary(){return this.$$.ctx[9]}set binary(e){this.$$set({binary:e}),_()}get scene(){return this.$$.ctx[4]}set scene(e){this.$$set({scene:e}),_()}get renderForAI(){return this.$$.ctx[10]}get getScene(){return this.$$.ctx[11]}get setScene(){return this.$$.ctx[12]}get renderNormal(){return this.$$.ctx[13]}get mode(){return this.$$.ctx[14]}set mode(e){this.$$set({mode:e}),_()}get setMode(){return this.$$.ctx[15]}get deleteMesh(){return this.$$.ctx[16]}get background_type(){return this.$$.ctx[17]}set background_type(e){this.$$set({background_type:e}),_()}get setBackground(){return this.$$.ctx[18]}get canvas(){return this.$$.ctx[0]}set canvas(e){this.$$set({canvas:e}),_()}}return customElements.define("fds-3d-scene",G),G}();
//# sourceMappingURL=fds-3d-scene.js.map
